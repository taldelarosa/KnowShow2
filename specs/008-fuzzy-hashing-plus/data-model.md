# Data Model: Fuzzy Hashing Plus Configuration System


## Core Entities


### Configuration


Primary configuration entity that encapsulates all system settings.

**Fields**:

- `Version` (string): Configuration schema version for migration
- `MatchConfidenceThreshold` (decimal, 0.0-1.0): Minimum confidence for episode matches
- `RenameConfidenceThreshold` (decimal, 0.0-1.0): Minimum confidence for file renaming
- `FuzzyHashThreshold` (int, 0-100): CTPH similarity threshold for fuzzy matching
- `HashingAlgorithm` (enum): Active hashing algorithm (MD5, SHA1, CTPH)
- `FilenamePatterns` (FilenamePatterns): Regex patterns for parsing filenames
- `FilenameTemplate` (string): Template for generating new filenames

**Relationships**:

- Contains one FilenamePatterns entity
- Used by ConfigurationService for validation and loading

**State Transitions**:

- Loading → Valid (successful validation)
- Loading → Invalid (validation errors)
- Valid → Reloading (file change detected)

### FilenamePatterns


Entity containing regex patterns for episode identification.

**Fields**:

- `PrimaryPattern` (string): Main SxxExx pattern
- `SecondaryPattern` (string): Alternative NxNN pattern
- `TertiaryPattern` (string): Dot-separated pattern
- `CustomPatterns` (List<string>): User-defined patterns

**Relationships**:

- Owned by Configuration entity
- Used by EpisodeIdentificationService

### HashingAlgorithm


Enumeration defining supported hashing methods.

**Values**:

- `MD5`: Legacy MD5 hashing (backward compatibility)
- `SHA1`: Legacy SHA1 hashing (backward compatibility)
- `CTPH`: Context-triggered piecewise hashing (fuzzy)

**Usage**:

- Selected in Configuration.HashingAlgorithm
- Determines which IHashingService implementation to use

### FuzzyHashResult


Result of CTPH fuzzy hashing comparison.

**Fields**:

- `Hash1` (string): First file's CTPH hash
- `Hash2` (string): Second file's CTPH hash
- `SimilarityScore` (int, 0-100): Computed similarity percentage
- `IsMatch` (bool): Whether similarity exceeds threshold
- `ComparisonTime` (TimeSpan): Time taken for comparison

**Relationships**:

- Generated by CTPhHashingService
- Consumed by EpisodeIdentificationService

## Validation Rules


### Configuration Validation


- **Version**: Must be valid semantic version string
- **MatchConfidenceThreshold**: Range 0.0-1.0, cannot exceed RenameConfidenceThreshold
- **RenameConfidenceThreshold**: Range 0.0-1.0, must be ≥ MatchConfidenceThreshold
- **FuzzyHashThreshold**: Range 0-100, required when HashingAlgorithm = CTPH
- **HashingAlgorithm**: Must be valid enum value
- **FilenameTemplate**: Must contain required placeholders: {SeriesName}, {Season}, {Episode}

### FilenamePatterns Validation


- **All Patterns**: Must be valid regex patterns
- **Named Groups**: Must contain capturing groups for series, season, episode
- **Compilation**: All patterns must compile without errors

## Service Interfaces


### IConfigurationService


Core configuration management interface.

**Methods**:

- `LoadConfiguration()`: Load config from file with validation
- `ReloadIfChanged()`: Check for changes and reload if needed
- `ValidateConfiguration(config)`: Validate config against rules
- `GetCurrentConfiguration()`: Return cached valid configuration

### IHashingService


Abstract hashing service interface.

**Methods**:

- `ComputeHash(filePath)`: Generate hash for single file
- `CompareFiles(file1, file2)`: Compare two files using selected algorithm
- `GetAlgorithmName()`: Return algorithm identifier

### ICTPhHashingService : IHashingService


CTPH-specific hashing implementation.

**Methods**:

- `ComputeFuzzyHash(filePath)`: Generate CTPH hash
- `CompareFuzzyHashes(hash1, hash2)`: Calculate similarity score
- `GetSimilarityThreshold()`: Return configured threshold
